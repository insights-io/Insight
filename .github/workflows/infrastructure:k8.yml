---
on:
  pull_request:
    paths:
      - '**/k8/**/*.yaml'
      - '.github/workflows/infrastructure:k8.yml'

jobs:
  helm-template:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: mamezou-tech/setup-helmfile@v0.6.0
        with:
          helmfile-version: v0.135.0
          helm-version: v3.4.0
      - run: helmfile template
        working-directory: infrastructure/k8/development
      - run: helmfile template
        working-directory: infrastructure/k8/tracing
      - run: helmfile template
        working-directory: infrastructure/k8/recording

  kustomize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: karancode/kustomize-github-action@master
        with:
          kustomize_version: '3.8.7'
          kustomize_comment: true
          kustomize_output_file: rendered.yml
          enable_alpha_plugins: true
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          docker run -v $(pwd):/project zegl/kube-score:v1.10.0 score -o ci ./project/rendered.yml > kube-score-results.txt
          echo "KUBE_SCORE_RESULTS=$(cat kube-score-results.txt)" >> $GITHUB_ENV
      - name: Comment PR ðŸ’¬
        uses: unsplash/comment-on-pr@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: '${{ env.KUBE_SCORE_RESULTS }}'
          check_for_duplicate_msg: true

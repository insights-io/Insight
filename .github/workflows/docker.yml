---
name: Docker
on: [push]

env:
  REGISTRY: registry.hub.docker.com
  REPOSITORY: insightio

jobs:
  k8-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        name: checkout
      - name: 'Kustomize Build'
        uses: karancode/kustomize-github-action@master
        with:
          kustomize_version: '3.2.0'
          kustomize_comment: true
          kustomize_output_file: 'gitops/rendered.yaml'
          enable_alpha_plugins: true
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_ACCESS_TOKEN }}
      - name: Setup helmfile
        uses: mamezou-tech/setup-helmfile@v0.3.0
        with:
          helmfile-version: 'v0.118.7'
          helm-version: 'v3.2.0'
      - name: Build infra
        run: |
          cd infrastructure/k8/dev && helmfile template

  build-auth-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/auth-api
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: auth/auth-api/docker/Dockerfile.jvm
          workdir: backend
          tag_names: true

  build-auth-api-migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/auth-api-migrations
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: Dockerfile
          workdir: backend/auth/auth-api/migrations/
          tag_names: true

  build-session-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/session-api
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: session/session-api/docker/Dockerfile.jvm
          workdir: backend
          tag_names: true

  build-session-api-migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/session-api-migrations
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: Dockerfile
          workdir: backend/session/session-api/migrations
          tag_names: true

  build-beacon-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/beacon-api
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: beacon/beacon-api/docker/Dockerfile.jvm
          workdir: backend
          tag_names: true

  build-search-indexer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/search-indexer
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: events/search-indexer/docker/Dockerfile.jvm
          workdir: backend
          tag_names: true

  build-frontend-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/frontend-app
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: frontend/app/docker/Dockerfile
          tag_names: true
          buildargs: auth_api_client_base_url=https://auth-api.dev.snuderls.eu,auth_api_server_base_url=http://auth-api,try_app_base_url=https://try.dev.snuderls.eu

  build-try-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ env.REPOSITORY }}/frontend-try
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          registry: ${{ env.REGISTRY }}
          dockerfile: frontend/try/docker/Dockerfile
          tag_names: true
          buildargs: auth_api_client_base_url=https://auth-api.dev.snuderls.eu,app_base_url=https://app.dev.snuderls.eu
